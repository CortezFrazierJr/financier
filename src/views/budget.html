<div class="budget" flex-months>
  <div class="budget__table">
    <div class="budget__thead">
      <div class="budget__tr">
        <div class="budget__td budget__category-label"></div>
        <div class="budget__td" colspan="{{budgetCtrl.showMonths * 3}}">
          <month-selector ng-model="dbCtrl.currentMonth"></month-selector>
        </div>
      </div>
      <div class="budget__tr month-overview__row">
        <div class="budget__th budget__category-label"></div>
        <div class="budget__th month-overview__month-overview"
             colspan="3"
             ng-repeat="month in dbCtrl.months | limitTo : budgetCtrl.showMonths"
             ng-class="{'budget__month-end': !$last}">
          <div class="month-overview__month-text">{{month.data._id | date: 'MMMM yyyy'}}</div>
          <dl class="month-overview__month-list">
            <dt>
              <span ng-if="dbCtrl.months[$index - 1]">{{dbCtrl.months[$index - 1].cache.totalIncome - dbCtrl.months[$index - 1].cache.totalBudget | intCurrency | currency}}</span>
            </dt>
            <dd>Not budgeted in {{dbCtrl.months[$index - 1].data._id | date: 'MMM'}}</dd>
            <dt>{{dbCtrl.months[$index - 1].cache.totalBalance}}</dt>
            <dd>Overspent in {{dbCtrl.months[$index - 1].data._id | date: 'MMM'}}</dd>
            <dt>{{month.cache.totalIncome | intCurrency | currency}}</dt>
            <dd>Income for {{month.data._id | date: 'MMM'}}</dd>
            <dt>{{month.cache.totalBudget | intCurrency | currency}}</dt>
            <dd>Budgeted in {{month.data._id | date: 'MMM'}}</dd>
          </dl>

          <div class="month-overview__month-total" ng-class="
            {
              'month-overview__month-total--negative': month.cache.totalAvailable < 0
            }">= {{month.cache.totalAvailable | intCurrency | currency}}</div>
          <div class="month-overview__month-total-subtext">Available to budget</div>
        </div>
      </div>
      <div class="budget__tr month-overview__row">
        <div class="budget__th budget__month-row budget__category-label"></div>
        <div class="budget__th budget__month-row month-overview__cell-head"
             ng-repeat-start="month in dbCtrl.months | limitTo : budgetCtrl.showMonths">Budgeted<div>{{month.cache.totalBudget | intCurrency | currency}}</div></div>
        <div class="budget__th budget__month-row month-overview__cell-head">Outflows<div>{{month.cache.totalTransactions | intCurrency | currency}}</div></div>
        <div class="budget__th budget__month-row month-overview__cell-head"
            ng-class="{'budget__month-end': !$last}"
            ng-repeat-end>Balance<div>{{month.cache.totalBalance | intCurrency | currency}}</div></div>
      </div>
    </div>
    <div class="budget__tbody overflowable" ng-sortable="masterCategorySortable">
      <div ng-repeat="masterCategory in budgetCtrl.masterCategories">
        <div class="budget__tr month-body__row month-body__row--master">
          <div class="budget__td budget__month-row budget__category-label">{{masterCategory.name}}</div>
            <div class="budget__td budget__month-row month-body__cell-head"
                ng-repeat-start="month in dbCtrl.months | limitTo : budgetCtrl.showMonths"
                ></div>
            <div class="budget__td budget__month-row month-body__cell-head">0.00</div>
            <div class="budget__td budget__month-row month-body__cell-head"
                ng-class="{'budget__month-end': !$last}"
                ng-repeat-end>{{month.categoryCache[row._id].balance | intCurrency}}</div>
        </div>
        
        <div ng-sortable="categorySortable" ng-mouseenter="masterCategorySortable.disabled = true" ng-mouseleave="masterCategorySortable.disabled = false">
          <div class="budget__tr month-body__row"
              ng-repeat="row in dbCtrl.categories"
              ng-init="catIndex = $index">
            <div class="budget__td budget__month-row budget__category-label">
              <i class="budget__month-row-note fa fa-sticky-note-o"></i>
              {{row.name}}
            </div>
            <div class="budget__td budget__month-row month-body__cell-head"
                ng-repeat-start="month in dbCtrl.months | limitTo : budgetCtrl.showMonths"
                >
              <input type="text"
                     class="budget__cell-input"
                     ng-attr-tabindex="{{(($index * dbCtrl.categories.length) + catIndex) + 1}}"
                     on-update="month.setBudget(row._id, model)"
                     view-model="month.data.categories[row._id].budget"></div>
            <div class="budget__td budget__month-row month-body__cell-head">0.00</div>
            <div class="budget__td budget__month-row month-body__cell-head"
                ng-class="{'budget__month-end': !$last}"
                ng-repeat-end>{{month.categoryCache[row._id].balance | intCurrency}}</div>
          </div>
        </div>
      </div>
      
    </div>

    <tfoot>

    </tfoot>

  </div>
</div>
